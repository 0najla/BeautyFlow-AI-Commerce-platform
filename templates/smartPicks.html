<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <!-- ====================================================================
     BeautyFlow - AI SmartPicks Page
     ====================================================================
     AI recommendations page: vibe selector, dynamic pricing, editable names,
     history/favorites sidebar (opens from right), product details modal,
     add-to-cart + share actions.

     Author: BeautyFlow Team
     Version: 1.0.0
     ==================================================================== -->

  <meta charset="UTF-8" />  
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect fill='white' rx='15' width='100' height='100'/%3E%3Ctext x='50' y='68' font-size='45' font-weight='bold' fill='%23e84a8a' text-anchor='middle'%3EBF%3C/text%3E%3C/svg%3E">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BeautyFlow - AI SmartPicks</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Tajawal:wght@400;500;700;800&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
<style>
.sp-main {
  padding: 40px 20px;
  max-width: 1400px;
  margin: 0 auto;
}

.sp-container {
  display: grid;
  grid-template-columns: 300px 1fr;
  gap: 40px;
  align-items: start;
}

/* ===== Vibe Sidebar ===== */
.sp-sidebar {
  background: white;
  border-radius: 20px;
  padding: 30px;
  box-shadow: 0 10px 40px rgba(232, 74, 127, 0.1);
  position: sticky;
  top: 100px;
}

.vibe-selector h3 {
  font-size: 1rem;
  color: #1a1a2e;
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.vibe-buttons {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.vibe-btn {
  padding: 14px 20px;
  border: 2px solid #fce7f3;
  border-radius: 12px;
  background: white;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 0.95rem;
  font-weight: 500;
  color: #4b5563;
  transition: all 0.3s ease;
}

.vibe-btn:hover {
  border-color: #e84a7f;
  background: #fdf2f8;
}

.vibe-btn.active {
  background: linear-gradient(135deg, #e84a7f, #ff6b9d);
  color: white;
  border-color: transparent;
}

.sp-features {
  margin-top: 30px;
  padding-top: 30px;
  border-top: 2px dashed #fce7f3;
}

.sp-features h4 {
  font-size: 0.95rem;
  color: #1a1a2e;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.sp-bullets {
  list-style: none;
  padding: 0;
  margin: 0;
}

.sp-bullets li {
  padding: 8px 0;
  font-size: 0.85rem;
  color: #6b7280;
  display: flex;
  align-items: center;
  gap: 10px;
}

.sp-bullets li i {
  color: #e84a7f;
  font-size: 0.8rem;
}

/* ===== Cards Section ===== */
.sp-cards-section {
  min-height: 500px;
}

.sp-cards-grid {
  display: grid !important;
  grid-template-columns: repeat(2, 1fr) !important;
  gap: 30px !important;
}

.sp-loading-state {
  display: none;
  grid-template-columns: repeat(2, 1fr) !important;
  gap: 30px !important;
}

.sp-loading-state.show {
  display: grid !important;
}

.sp-empty-state {
  display: grid;
  grid-template-columns: repeat(2, 1fr) !important;
  gap: 30px !important;
}

.sp-empty-state.hide {
  display: none !important;
}

.sp-cards-grid.hide {
  display: none !important;
}

/* ===== Card Styling ===== */
.sp-card {
  background: white;
  border-radius: 20px;
  overflow: hidden;
  box-shadow: 0 10px 40px rgba(232, 74, 127, 0.1);
  transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  position: relative;
}

.sp-card:hover {
  transform: translateY(-10px);
  box-shadow: 0 20px 60px rgba(232, 74, 127, 0.2);
}

.sp-card.empty {
  padding: 60px 30px;
  text-align: center;
  border: 2px dashed #fce7f3;
  box-shadow: none;
}

.sp-card.empty:hover {
  transform: none;
  box-shadow: none;
}

.empty-icon {
  width: 80px;
  height: 80px;
  background: linear-gradient(135deg, #fce7f3, #fdf2f8);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 20px;
  font-size: 2rem;
  color: #e84a7f;
}

.sp-card.empty h3 {
  color: #1a1a2e;
  margin-bottom: 10px;
  font-size: 1.1rem;
}

.sp-card.empty p {
  color: #9ca3af;
  font-size: 0.9rem;
  line-height: 1.6;
}

.sp-card.loading {
  height: 450px;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 2px dashed #fce7f3;
}

.loading-animation {
  text-align: center;
}

.loading-heart {
  font-size: 3rem;
  animation: heartBeat 1.2s infinite;
}

@keyframes heartBeat {
  0%, 100% { transform: scale(1); }
  25% { transform: scale(1.3); }
  50% { transform: scale(1); }
}

.loading-text {
  margin-top: 16px;
  color: #9ca3af;
  font-weight: 500;
}

/* ===== Card Menu ===== */
.sp-card-menu {
  position: absolute;
  top: 12px;
  left: 12px;
  z-index: 10;
}

.menu-toggle {
  width: 36px;
  height: 36px;
  background: white;
  border: none;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  transition: all 0.3s;
}

.menu-toggle:hover {
  background: #e84a7f;
  color: white;
}

.menu-dropdown {
  position: absolute;
  top: 100%;
  left: 0;
  background: white;
  border-radius: 12px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.15);
  opacity: 0;
  visibility: hidden;
  transform: translateY(-10px);
  transition: all 0.3s ease;
  min-width: 180px;
  overflow: hidden;
  margin-top: 8px;
}

.sp-card-menu.open .menu-dropdown {
  opacity: 1;
  visibility: visible;
  transform: translateY(0);
}

.menu-item {
  width: 100%;
  padding: 12px 16px;
  background: none;
  border: none;
  text-align: left;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 0.9rem;
  color: #4b5563;
  transition: all 0.2s;
}

.menu-item:hover {
  background: #fce7f3;
  color: #e84a7f;
}

/* ===== Card Image ===== */
.sp-img {
  position: relative;
  height: 280px;
  overflow: hidden;
  background: linear-gradient(135deg, #fdf2f8, #fce7f3);
}

.sp-img img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: transform 0.5s ease;
}

.sp-card:hover .sp-img img {
  transform: scale(1.05);
}

.sp-badge {
  position: absolute;
  top: 12px;
  right: 12px;
  background: linear-gradient(135deg, #e84a7f, #ff6b9d);
  color: white;
  padding: 6px 14px;
  border-radius: 20px;
  font-size: 0.75rem;
  font-weight: 600;
  box-shadow: 0 4px 15px rgba(232, 74, 127, 0.3);
}

/* ===== Card Info ===== */
.sp-card-info {
  padding: 20px;
}

.sp-product-name {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 1.1rem;
  font-weight: 600;
  color: #1a1a2e;
  margin-bottom: 12px;
}

.sp-product-name .name-text {
  flex: 1;
}

.edit-name-btn {
  background: none;
  border: none;
  cursor: pointer;
  padding: 4px 8px;
  border-radius: 6px;
  color: #9ca3af;
  font-size: 0.85rem;
  transition: all 0.2s ease;
  opacity: 0;
}

.sp-card:hover .edit-name-btn {
  opacity: 1;
}

.edit-name-btn:hover {
  background: rgba(232, 74, 127, 0.1);
  color: #e84a7f;
}

.edit-name-wrapper {
  display: flex;
  align-items: center;
  gap: 6px;
  width: 100%;
  background: #fff5f8;
  padding: 6px 10px;
  border-radius: 10px;
  border: 2px solid #f8bbd9;
}

.edit-name-input {
  flex: 1;
  padding: 8px;
  border: none;
  border-radius: 6px;
  font-size: 0.95rem;
  font-weight: 500;
  color: #1a1a2e;
  background: white;
  outline: none;
}

.save-name-btn,
.cancel-name-btn {
  width: 30px;
  height: 30px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.save-name-btn {
  background: #4caf50;
  color: white;
}

.cancel-name-btn {
  background: #ef5350;
  color: white;
}

.sp-product-specs {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-bottom: 12px;
}

.spec-badge {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  padding: 4px 10px;
  background: #fce7f3;
  color: #e84a7f;
  font-size: 0.75rem;
  font-weight: 600;
  border-radius: 20px;
}

.sp-product-price {
  font-size: 1.5rem;
  font-weight: 700;
  color: #e84a7f;
  margin-bottom: 16px;
  display: flex;
  justify-content: center;
  align-items: baseline;
  gap: 6px;
  text-align: center;
  width: 100%;
}

.sp-product-price .price-value {
  font-size: 1.8rem;
  font-weight: 800;
}

.sp-select {
  width: calc(100% - 40px);
  margin: 0 20px 20px;
  padding: 14px 20px;
  background: linear-gradient(135deg, #e84a7f, #ff6b9d);
  color: white;
  border: none;
  border-radius: 12px;
  font-size: 0.95rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

.sp-select:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 25px rgba(232, 74, 127, 0.4);
}

/* =====================================================
   HISTORY SIDEBAR - SAME AS AI.html (Opens from RIGHT)
===================================================== */

/* History Toggle Button - Right side */
.history-toggle {
  position: fixed;
  right: 0;
  top: 50%;
  transform: translateY(-50%);
  background: linear-gradient(135deg, #e84a7f, #ff6b9d);
  color: white;
  padding: 14px 18px;
  border-radius: 16px 0 0 16px;
  cursor: pointer;
  box-shadow: 0 4px 20px rgba(232, 74, 127, 0.3);
  transition: all 0.3s ease;
  z-index: 100;
  display: flex;
  align-items: center;
  gap: 10px;
  font-weight: 600;
  font-size: 14px;
  border: none;
}

.history-toggle:hover {
  padding-left: 28px;
  box-shadow: 0 6px 25px rgba(232, 74, 127, 0.4);
}

/* Overlay */
.sidebar-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  z-index: 1000;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
}

.sidebar-overlay.open {
  opacity: 1;
  visibility: visible;
}

/* Sidebar - Opens from RIGHT (same as AI.html) */
.ai-sidebar {
  position: fixed;
  right: -360px;
  top: 0;
  width: 340px;
  height: 100vh;
  background: white;
  box-shadow: -5px 0 30px rgba(0,0,0,0.15);
  transition: right 0.3s ease;
  z-index: 1001;
  overflow-y: auto;
}

.ai-sidebar.open {
  right: 0;
}

/* Sidebar Header */
.sidebar-header {
  padding: 24px;
  background: linear-gradient(135deg, #fdf2f8, #fce7f3);
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  z-index: 10;
}

.sidebar-header h3 {
  margin: 0;
  font-size: 18px;
  font-weight: 700;
  color: #1a1a2e;
  display: flex;
  align-items: center;
  gap: 10px;
}

.sidebar-header h3 i {
  color: #e84a7f;
}

.sidebar-close {
  width: 40px;
  height: 40px;
  background: white;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  font-size: 18px;
  color: #4b5563;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
}

.sidebar-close:hover {
  background: #e84a7f;
  color: white;
  transform: rotate(90deg);
}

/* Sidebar Tabs */
.sidebar-tabs {
  display: flex;
  border-bottom: 2px solid #f3f4f6;
  background: white;
  position: sticky;
  top: 76px;
  z-index: 9;
}

.tab-btn {
  flex: 1;
  padding: 16px;
  background: none;
  border: none;
  cursor: pointer;
  font-weight: 600;
  font-size: 14px;
  color: #9ca3af;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.tab-btn.active {
  color: #e84a7f;
  border-bottom: 3px solid #e84a7f;
}

.tab-btn:hover:not(.active) {
  background: #f9fafb;
}

/* Tab Content */
.tab-content {
  display: none;
  padding: 20px;
}

.tab-content.active {
  display: block;
}

/* Empty State */
.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: #9ca3af;
}

.empty-state i {
  font-size: 48px;
  margin-bottom: 16px;
  color: #fda4af;
}

.empty-state p {
  font-weight: 600;
  margin-bottom: 4px;
  color: #6b7280;
}

.empty-state span {
  font-size: 13px;
}

/* Sidebar Items */
.sidebar-item {
  background: white;
  border: 2px solid #f3f4f6;
  border-radius: 16px;
  padding: 14px;
  margin-bottom: 16px;
  transition: all 0.3s ease;
}

.sidebar-item:hover {
  border-color: #e84a7f;
  transform: translateY(-3px);
  box-shadow: 0 8px 25px rgba(232, 74, 127, 0.15);
}

.sidebar-item img {
  width: 100%;
  height: 140px;
  object-fit: cover;
  border-radius: 12px;
  margin-bottom: 12px;
  display: block;
}

.sidebar-item-name {
  font-weight: 600;
  color: #1a1a2e;
  font-size: 0.95rem;
  margin-bottom: 4px;
}

.sidebar-item-info {
  font-size: 0.85rem;
  color: #e84a7f;
  font-weight: 600;
  margin-bottom: 12px;
}

/* Sidebar Buttons */
.sidebar-item-actions {
  display: flex;
  gap: 8px;
}

.sidebar-item-btn {
  flex: 1;
  padding: 10px 12px;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  font-size: 0.8rem;
  font-weight: 600;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  background: #f3f4f6;
  color: #4b5563;
}

.sidebar-item-btn:hover {
  background: #fce7f3;
  color: #e84a7f;
}

.sidebar-item-btn.load-design:hover {
  background: linear-gradient(135deg, #e84a7f, #ff6b9d);
  color: white;
}

.sidebar-item-btn.favorite:hover {
  background: #e84a7f;
  color: white;
}

.sidebar-item-btn.remove-favorite:hover {
  background: #ef4444;
  color: white;
}

/* ===== Card Placeholder ===== */
.placeholder-card {
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 400px;
  border: 2px dashed #fce7f3;
  background: linear-gradient(135deg, #fdf2f8, #fff);
}

.card-placeholder-content {
  text-align: center;
  padding: 40px;
}

.card-placeholder-content .placeholder-icon {
  width: 80px;
  height: 80px;
  background: linear-gradient(135deg, #fce7f3, #fdf2f8);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 20px;
  box-shadow: 0 8px 25px rgba(232, 74, 127, 0.15);
}

.card-placeholder-content .placeholder-icon i {
  font-size: 2rem;
  color: #e84a7f;
}

.card-placeholder-content h3 {
  color: #1a1a2e;
  font-size: 1.1rem;
  font-weight: 600;
  margin-bottom: 10px;
}

.card-placeholder-content p {
  color: #9ca3af;
  font-size: 0.9rem;
  line-height: 1.6;
}

.card-placeholder-content p strong {
  color: #e84a7f;
}

/* ===== Toast ===== */
.toast {
  position: fixed;
  bottom: 30px;
  right: 30px;
  background: #1a1a2e;
  color: white;
  padding: 16px 28px;
  border-radius: 14px;
  font-weight: 500;
  box-shadow: 0 10px 40px rgba(0,0,0,0.3);
  transform: translateX(400px);
  opacity: 0;
  transition: all 0.4s ease;
  z-index: 10000;
}

.toast.show {
  transform: translateX(0);
  opacity: 1;
}

/* ===== Modal ===== */
.details-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 9999;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
}

.details-modal.active {
  opacity: 1;
  visibility: visible;
}

.modal-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.6);
  backdrop-filter: blur(5px);
}

.modal-content {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0.9);
  background: white;
  border-radius: 24px;
  max-width: 800px;
  width: 90%;
  max-height: 85vh;
  overflow: auto;
  transition: transform 0.3s ease;
}

.details-modal.active .modal-content {
  transform: translate(-50%, -50%) scale(1);
}

.modal-close {
  position: absolute;
  top: 15px;
  right: 15px;
  width: 40px;
  height: 40px;
  background: #f3f4f6;
  border: none;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.2rem;
  color: #6b7280;
  transition: all 0.3s;
  z-index: 10;
}

.modal-close:hover {
  background: #e84a7f;
  color: white;
}

.modal-body {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 30px;
  padding: 30px;
}

.modal-image {
  border-radius: 16px;
  overflow: hidden;
  background: #fdf2f8;
}

.modal-image img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.modal-details h2 {
  font-size: 1.4rem;
  color: #1a1a2e;
  margin-bottom: 20px;
}

.detail-section {
  margin-bottom: 20px;
}

.detail-section h3 {
  font-size: 0.95rem;
  color: #e84a7f;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.detail-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
}

.detail-item {
  display: flex;
  justify-content: space-between;
  padding: 10px 12px;
  background: #f9fafb;
  border-radius: 8px;
}

.detail-label {
  color: #6b7280;
  font-size: 0.8rem;
}

.detail-value {
  color: #1a1a2e;
  font-weight: 600;
  font-size: 0.8rem;
}

.pricing-info {
  background: #fdf2f8;
  border-radius: 12px;
  padding: 16px;
}

.price-row {
  display: flex;
  justify-content: space-between;
  padding: 8px 0;
}

.price-row.final {
  font-size: 1.1rem;
  font-weight: 700;
  color: #e84a7f;
  border-top: 1px solid #fce7f3;
  padding-top: 12px;
  margin-top: 8px;
}

.modal-actions {
  display: flex;
  gap: 12px;
  margin-top: 20px;
}

.modal-btn {
  flex: 1;
  padding: 12px 16px;
  border: none;
  border-radius: 10px;
  font-size: 0.9rem;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  transition: all 0.3s;
}

.modal-btn.primary {
  background: linear-gradient(135deg, #e84a7f, #ff6b9d);
  color: white;
}

.modal-btn.secondary {
  background: #f3f4f6;
  color: #4b5563;
}

.main-footer {
   background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 50%, #fbcfe8 100%);
   color: #1a1a2e;
    padding: 60px 0 30px;
  }

  .footer-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 24px;
  }

    .footer-grid {
      display: grid;
      grid-template-columns: 1.5fr 1fr 1fr 1fr;
      gap: 40px;
      margin-bottom: 40px;
    }

    .footer-logo {
      height: 40px;
      margin-bottom: 16px;
    }

    .footer-brand p {
      font-size: 14px;
      color: #6b7280;
      line-height: 1.6;
      margin-bottom: 20px;
    }

    .footer-social {
      display: flex;
      gap: 12px;
    }

    .footer-social a {
      width: 40px;
      height: 40px;
      background: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #e84a7f;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(232, 74, 127, 0.15);
    }

    .footer-social a:hover {
      background: #e84a7f;
      color: white;
      transform: translateY(-4px);
      box-shadow: 0 8px 25px rgba(232, 74, 127, 0.3);
    }

    .footer-links h4,
    .footer-contact h4 {
      font-size: 16px;
      margin-bottom: 20px;
      color: #1a1a2e;
      font-weight: 700;
    }

    .footer-links a {
      display: block;
      color: #6b7280;
      text-decoration: none;
      margin-bottom: 12px;
      font-size: 14px;
      transition: all 0.3s;
    }

    .footer-links a:hover {
      color: #e84a7f;
      transform: translateX(5px);
    }

    .footer-contact p {
      font-size: 14px;
      color: #6b7280;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .footer-contact i {
      color: #e84a7f;
    }

    .footer-bottom {
      border-top: 1px solid rgba(232, 74, 127, 0.2);
      padding-top: 30px;
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      color: #6b7280;
    }

    .footer-bottom i {
      color: #e84a7f;
    }

/* ===== Responsive ===== */
@media (max-width: 1000px) {
  .sp-container {
    grid-template-columns: 1fr;
  }
  
  .sp-sidebar {
    position: static;
  }
}

@media (max-width: 700px) {
  .sp-cards-grid,
  .sp-empty-state,
  .sp-loading-state,
  .sp-loading-state.show {
    grid-template-columns: 1fr !important;
  }
  
  .modal-body {
    grid-template-columns: 1fr;
  }
  
  .edit-name-btn {
    opacity: 1;
  }
  
  .ai-sidebar {
    width: 100%;
    right: -100%;
  }
}
</style>
</head>

<body class="smartPicks-page">
  
  <!-- ========== HEADER ========== -->
  <header class="main-header scrolled" id="mainHeader">
    <div class="header-container">
      <a href="{{ url_for('home_index') }}" class="header-logo">
        <img src="{{ url_for('static', filename='images/BFlogo.png') }}" alt="BeautyFlow">
      </a>
      
      <nav class="header-nav">
        <a href="{{ url_for('home_index') }}" class="nav-link">
          <i class="fas fa-home"></i>
          <span>Home</span>
        </a>
        <a href="{{ url_for('costSharing_page') }}" class="nav-link">
          <i class="fas fa-users"></i>
          <span>Cost-Sharing</span>
        </a>
        <a href="{{ url_for('design_options') }}" class="nav-link active">
          <i class="fas fa-magic"></i>
          <span>Design</span>
        </a>
        <a href="{{ url_for('about_page') }}" class="nav-link">
          <i class="fas fa-info-circle"></i>
          <span>About</span>
        </a>
        <a href="{{ url_for('help_page') }}" class="nav-link">
          <i class="fas fa-question-circle"></i>
          <span>Help</span>
        </a>
      </nav>
      
      <div class="header-actions">
        <a href="/cart" class="cart-btn">
          <i class="fas fa-shopping-bag"></i>
          <span class="cart-badge" id="cart-count">0</span>
        </a>
        <a href="{{ url_for('account_page') }}" class="account-btn">
          <i class="fas fa-user"></i>
        </a>
        <button class="mobile-menu-btn" id="mobileMenuBtn">
          <span></span>
          <span></span>
          <span></span>
        </button>
      </div>
    </div>
    
    <div class="mobile-menu" id="mobileMenu">
      <a href="{{ url_for('home_index') }}"><i class="fas fa-home"></i> Home</a>
      <a href="{{ url_for('design_options') }}"><i class="fas fa-magic"></i> Design</a>
      <a href="{{ url_for('about_page') }}"><i class="fas fa-info-circle"></i> About</a>
      <a href="{{ url_for('help_page') }}"><i class="fas fa-question-circle"></i> Help</a>
      <a href="/cart"><i class="fas fa-shopping-bag"></i> Cart</a>
      <a href="{{ url_for('account_page') }}"><i class="fas fa-user"></i> Account</a>
    </div>
  </header>

  <!-- ========== HERO SECTION ========== -->
  <section class="sp-hero">
    <div class="sp-hero-bg">
      <div class="hero-shape shape-1"></div>
      <div class="hero-shape shape-2"></div>
      <div class="hero-shape shape-3"></div>
    </div>
    <div class="sp-hero-content">
      <div class="hero-badge animate-fade-down">
        <i class="fas fa-lightbulb"></i>
        <span>AI Recommendations</span>
      </div>
      <h1 class="animate-fade-up">
        <span>Only for your</span>
        <span class="highlight">Business</span>
      </h1>
      <p class="animate-fade-up delay-1">
        Exclusive AI-generated recommendations tailored to your unique style
      </p>
    </div>
  </section>
  <br><br>

  <!-- ========== History Toggle Button (RIGHT) ========== -->
  <button class="history-toggle" id="historyToggle">
    <i class="fas fa-history"></i>
    <span>History</span>
  </button>

  <!-- ========== Sidebar Overlay ========== -->
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <!-- ========== Sidebar (Opens from RIGHT) ========== -->
  <aside class="ai-sidebar" id="aiSidebar">
    <div class="sidebar-header">
      <h3><i class="fas fa-palette"></i> Your Designs</h3>
      <button class="sidebar-close" id="sidebarClose">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="sidebar-tabs">
      <button class="tab-btn active" data-tab="favorites">
        <i class="fas fa-heart"></i> Favorites
      </button>
      <button class="tab-btn" data-tab="history">
        <i class="fas fa-clock"></i> History
      </button>
    </div>

    <div class="tab-content active" id="favorites-tab">
      <div class="empty-state">
        <i class="fas fa-heart"></i>
        <p>No favorites yet</p>
        <span>Save designs you love</span>
      </div>
    </div>

    <div class="tab-content" id="history-tab">
      <div class="sidebar-items" id="history-items">
        <div class="empty-state">
          <i class="fas fa-image"></i>
          <p>No designs yet</p>
          <span>Start creating to see your history</span>
        </div>
      </div>
    </div>
  </aside>

  <!-- ========== MAIN CONTENT ========== -->
  <main class="sp-main">
    <div class="sp-container">
      
      <!-- Sidebar -->
      <aside class="sp-sidebar">
        <div class="vibe-selector">
          <h3><i class="fas fa-palette"></i> Choose Your Style</h3>
          <div class="vibe-buttons">
            <button class="vibe-btn" data-vibe="luxury">
              <i class="fas fa-gem"></i>
              <span>Luxury</span>
            </button>
            <button class="vibe-btn" data-vibe="cute">
              <i class="fas fa-heart"></i>
              <span>Cute</span>
            </button>
            <button class="vibe-btn" data-vibe="minimal">
              <i class="fas fa-circle"></i>
              <span>Minimal</span>
            </button>
          </div>
        </div>

        <div class="sp-features">
          <h4><i class="fas fa-star"></i> Why SmartPicks?</h4>
          <ul class="sp-bullets">
            <li><i class="fas fa-check"></i> Exclusive AI-generated designs</li>
            <li><i class="fas fa-check"></i> Dynamic pricing based on specs</li>
            <li><i class="fas fa-check"></i> Editable product names</li>
            <li><i class="fas fa-check"></i> 100% unique to your business</li>
          </ul>
        </div>
      </aside>

      <!-- Cards Section -->
      <section class="sp-cards-section">
        
        <!-- Empty State (shown by default) -->
        <div id="empty-state" class="sp-empty-state">
          <div class="sp-card empty">
            <div class="empty-icon">
              <i class="fas fa-wand-magic-sparkles"></i>
            </div>
            <h3>Ready to Create Magic?</h3>
            <p>Choose a style to generate AI-powered product designs</p>
          </div>
          <div class="sp-card empty">
            <div class="empty-icon">
              <i class="fas fa-sparkles"></i>
            </div>
            <h3>Unique Designs Await</h3>
            <p>Each design has unique specs and dynamic pricing</p>
          </div>
        </div>

        <!-- Loading State -->
        <div id="loading-cards" class="sp-loading-state">
          <div class="sp-card loading">
            <div class="loading-animation">
              <div class="loading-heart">ðŸ’—</div>
              <div class="loading-text">Creating your design...</div>
            </div>
          </div>
          <div class="sp-card loading">
            <div class="loading-animation">
              <div class="loading-heart">ðŸ’—</div>
              <div class="loading-text">Creating your design...</div>
            </div>
          </div>
        </div>

        <!-- Generated Cards (hidden by default) -->
        <div id="cards-container" class="sp-cards-grid hide">
          
          <!-- Card 1 - Product Card -->
          <article class="sp-card generated-card" id="card-1">
            <div class="sp-card-menu">
              <button class="menu-toggle"><i class="fas fa-ellipsis-v"></i></button>
              <div class="menu-dropdown">
                <button class="menu-item view-details"><i class="fas fa-info-circle"></i> View Details</button>
                <button class="menu-item add-favorite"><i class="fas fa-heart"></i> Add to Favorites</button>
                <button class="menu-item share-product"><i class="fas fa-share-alt"></i> Share</button>
              </div>
            </div>
            
            <div class="sp-img">
              <img src="" alt="AI Product 1" />
              <div class="sp-badge">AI Generated</div>
            </div>
            
            <div class="sp-card-info">
              <h3 class="sp-product-name">
                <span class="name-text">Custom Product</span>
                <button class="edit-name-btn" title="Edit name">
                  <i class="fas fa-pen"></i>
                </button>
              </h3>
              <div class="sp-product-specs">
                <span class="spec-badge spec-type"><i class="fas fa-tag"></i> Product</span>
                <span class="spec-badge spec-finish"><i class="fas fa-star"></i> Premium</span>
              </div>
              <p class="sp-product-price"><span class="price-value">0</span> SAR</p>
            </div>
            
            <button class="sp-select">
              <i class="fas fa-shopping-cart"></i> Add to Cart
            </button>
          </article>

          <!-- Card 2 - PLACEHOLDER (stays until user selects second image) -->
          <article class="sp-card placeholder-card" id="card-2">
            <div class="card-placeholder-content">
              <div class="placeholder-icon">
                <i class="fas fa-image"></i>
              </div>
              <h3>Select Another Design</h3>
              <p>Click <strong>View</strong> from History<br>to display your second choice here</p>
            </div>
          </article>

        </div>
      </section>

    </div>
  </main>

  <!-- ========== DETAILS MODAL ========== -->
  <div class="details-modal" id="detailsModal">
    <div class="modal-overlay"></div>
    <div class="modal-content">
      <button class="modal-close"><i class="fas fa-times"></i></button>
      
      <div class="modal-body">
        <div class="modal-image">
          <img id="modalProductImage" src="" alt="Product">
        </div>
        
        <div class="modal-details">
          <h2 id="modalProductName">Product Name</h2>
          
          <div class="detail-section">
            <h3><i class="fas fa-info-circle"></i> Product Information</h3>
            <div class="detail-grid">
              <div class="detail-item">
                <span class="detail-label">Type:</span>
                <span class="detail-value" id="modalProductType">Product</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Formula:</span>
                <span class="detail-value" id="modalFormula">Premium</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Coverage:</span>
                <span class="detail-value" id="modalCoverage">Medium</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Finish:</span>
                <span class="detail-value" id="modalFinish">Natural</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Skin Type:</span>
                <span class="detail-value" id="modalSkinType">All Types</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Size:</span>
                <span class="detail-value" id="modalSize">10g</span>
              </div>
            </div>
          </div>

          <div class="detail-section">
            <h3><i class="fas fa-tag"></i> Pricing</h3>
            <div class="pricing-info">
              <div class="price-row">
                <span>Base Price:</span>
                <span id="modalBasePrice">50 SAR</span>
              </div>
              <div class="price-row final">
                <span>Final Price:</span>
                <span id="modalFinalPrice">75 SAR</span>
              </div>
            </div>
          </div>

          <div class="modal-actions">
            <button class="modal-btn primary add-to-cart-modal">
              <i class="fas fa-shopping-cart"></i> Add to Cart
            </button>
            <button class="modal-btn secondary add-favorite-modal">
              <i class="fas fa-heart"></i> Favorites
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>
<!-- FOOTER -->
  <footer class="main-footer">
    <div class="footer-container">
      <div class="footer-grid">
        <div class="footer-brand">
          <img src="{{ url_for('static', filename='images/BFlogo.png') }}" alt="BeautyFlow" class="footer-logo">
          <p>AI-powered collaborative import platform for beauty businesses in Saudi Arabia</p>
          <div class="footer-social">
            <a href="#"><i class="fab fa-twitter"></i></a>
            <a href="#"><i class="fab fa-instagram"></i></a>
            <a href="#"><i class="fab fa-linkedin"></i></a>
          </div>
        </div>
        
        <div class="footer-links">
          <h4>Quick Links</h4>
          <a href="{{ url_for('home_index') }}">Home</a>
          <a href="{{ url_for('design_options') }}">Design Options</a>
          <a href="{{ url_for('about_page') }}">About Us</a>
          <a href="{{ url_for('help_page') }}">Help Center</a>
        </div>
        
        <div class="footer-links">
          <h4>Services</h4>
          <a href="/AI">AI Custom Design</a>
          <a href="/smartPicks">SmartPicks</a>
          <a href="/cart">Shopping Cart</a>
        </div>
        
        <div class="footer-contact">
          <h4>Contact Us</h4>
          <p><i class="fas fa-envelope"></i> <a href="mailto:beautyflow.team@gmail.com">beautyflow.team@gmail.com</a></p>
          <p><i class="fas fa-phone"></i> +966 XX XXX XXXX</p>
          <p><i class="fas fa-map-marker-alt"></i> Al-Baha, Saudi Arabia</p>
        </div>
      </div>
      
      <div class="footer-bottom">
        <p>&copy; 2025 BeautyFlow. All rights reserved.</p>
        <p>Made with <i class="fas fa-heart"></i> by BeautyFlow Team</p>
      </div>
    </div>
  </footer>
  <!-- ========== JAVASCRIPT ========== -->
  <script>

document.addEventListener("DOMContentLoaded", () => {
  if (!document.body.classList.contains("smartPicks-page")) return;

  // Elements
  const vibeButtons = document.querySelectorAll(".vibe-btn");
  const emptyState = document.getElementById("empty-state");
  const loadingState = document.getElementById("loading-cards");
  const cardsContainer = document.getElementById("cards-container");
  const detailsModal = document.getElementById("detailsModal");
  const generatedCards = document.querySelectorAll(".generated-card");

  // Sidebar Elements (same as AI.html)
  const historyToggle = document.getElementById("historyToggle");
  const aiSidebar = document.getElementById("aiSidebar");
  const sidebarOverlay = document.getElementById("sidebarOverlay");
  const sidebarClose = document.getElementById("sidebarClose");
  const tabBtns = document.querySelectorAll(".sidebar-tabs .tab-btn");

  // âœ… Track which cards have products (persistent state)
  let card1Filled = false;
  let card2Filled = false;

  console.log("ðŸš€ SmartPicks initialized");

  // ========================================
  // PRICING ALGORITHM
  // ========================================
  const BASE_PRICES = {
    LIPSTICK: 45, MASCARA: 50, BLUSH: 55, FOUNDATION: 65,
    EYELINER: 40, EYESHADOW: 60, HIGHLIGHTER: 55,
    BRONZER: 55, PRIMER: 60, SETTING_SPRAY: 50
  };

  const FORMULA_MULT = { WATER: 1.0, OIL: 1.05, CREAM: 1.03, GEL: 1.02, POWDER: 0.98, SILICONE: 1.08 };
  const COVERAGE_MULT = { SHEER: 0.95, MEDIUM: 1.0, FULL: 1.05 };
  const FINISH_MULT = { MATTE: 1.02, NATURAL: 1.0, DEWY: 1.03, GLOWY: 1.04, SATIN: 1.02 };
  const SKIN_MULT = { NORMAL: 1.0, OILY: 1.02, DRY: 1.03, COMBINATION: 1.03, SENSITIVE: 1.05 };
  const VIBE_MULT = { luxury: 1.15, cute: 1.08, minimal: 1.0 };
  const MAX_PRICE = 150;

  const PRODUCT_SIZES = {
    LIPSTICK: "3.5g", MASCARA: "8ml", BLUSH: "5g", FOUNDATION: "30ml",
    EYELINER: "0.5ml", EYESHADOW: "1.5g", HIGHLIGHTER: "8g",
    BRONZER: "8g", PRIMER: "30ml", SETTING_SPRAY: "60ml"
  };

  function getProductSize(productType) {
    return PRODUCT_SIZES[productType] || "10g";
  }

  function randomPick(arr) {
    return arr[Math.floor(Math.random() * arr.length)];
  }

  function generateSpecs(vibe) {
    return {
      product_type: randomPick(Object.keys(BASE_PRICES)),
      formula: randomPick(Object.keys(FORMULA_MULT)),
      coverage: randomPick(Object.keys(COVERAGE_MULT)),
      finish: randomPick(Object.keys(FINISH_MULT)),
      skin_type: randomPick(Object.keys(SKIN_MULT)),
      vibe: vibe
    };
  }

  function calculatePrice(specs) {
    const base = BASE_PRICES[specs.product_type] || 50;
    let price = base 
      * (FORMULA_MULT[specs.formula] || 1)
      * (COVERAGE_MULT[specs.coverage] || 1)
      * (FINISH_MULT[specs.finish] || 1)
      * (SKIN_MULT[specs.skin_type] || 1)
      * (VIBE_MULT[specs.vibe] || 1);
    
    price = Math.min(Math.round(price / 5) * 5, MAX_PRICE);
    return { base_price: base, final_price: price };
  }

  function generateName(specs, vibe) {
    const vibeWords = {
      luxury: ["Royal", "Luxe", "Elite", "Diamond", "Velvet", "Gold", "Prestige"],
      cute: ["Sweet", "Dreamy", "Bloom", "Sugar", "Petal", "Berry", "Honey"],
      minimal: ["Pure", "Clean", "Soft", "Bare", "Fresh", "Clear", "Essential"]
    };
    const productWords = {
      LIPSTICK: ["Kiss", "Lip"], MASCARA: ["Lash", "Flutter"], BLUSH: ["Flush", "Glow"],
      FOUNDATION: ["Skin", "Base"], EYELINER: ["Line", "Edge"], EYESHADOW: ["Shadow"],
      HIGHLIGHTER: ["Beam", "Radiant"], BRONZER: ["Sun", "Bronze"], PRIMER: ["Prep"],
      SETTING_SPRAY: ["Set", "Lock"]
    };
    const vWord = randomPick(vibeWords[vibe] || vibeWords.minimal);
    const pWord = randomPick(productWords[specs.product_type] || ["Beauty"]);
    return `${vWord} ${pWord}`;
  }

  function buildPrompt(specs, vibe) {
    const vibeDesc = {
      luxury: "Luxury high-end style, black and gold packaging, glass materials",
      cute: "Cute pastel kawaii style, soft pink colors, rounded shapes",
      minimal: "Ultra minimal style, clean white packaging, simple geometry"
    };
    const productNames = {
      LIPSTICK: "lipstick", MASCARA: "mascara", BLUSH: "blush compact",
      FOUNDATION: "foundation bottle", EYELINER: "eyeliner pen", EYESHADOW: "eyeshadow palette",
      HIGHLIGHTER: "highlighter", BRONZER: "bronzer", PRIMER: "primer bottle",
      SETTING_SPRAY: "setting spray"
    };
    return `Professional product photo of a single ${productNames[specs.product_type] || "cosmetic"}, ${vibeDesc[vibe]}, studio lighting, white background, commercial quality`;
  }

  // ========================================
  // SIDEBAR (Same as AI.html - Opens from RIGHT)
  // ========================================
  function openSidebar() {
    if (aiSidebar) aiSidebar.classList.add("open");
    if (sidebarOverlay) sidebarOverlay.classList.add("open");
    document.body.style.overflow = "hidden";
    loadHistoryFromBackend();
    loadFavoritesFromBackend();
  }

  function closeSidebar() {
    if (aiSidebar) aiSidebar.classList.remove("open");
    if (sidebarOverlay) sidebarOverlay.classList.remove("open");
    document.body.style.overflow = "";
  }

  if (historyToggle) historyToggle.addEventListener("click", openSidebar);
  if (sidebarClose) sidebarClose.addEventListener("click", closeSidebar);
  if (sidebarOverlay) sidebarOverlay.addEventListener("click", closeSidebar);

  // Sidebar Tabs
  tabBtns.forEach(btn => {
    btn.addEventListener("click", () => {
      tabBtns.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      document.querySelectorAll(".tab-content").forEach(t => t.classList.remove("active"));
      const targetTab = document.getElementById(btn.dataset.tab + "-tab");
      if (targetTab) targetTab.classList.add("active");
    });
  });

  // Load History
  async function loadHistoryFromBackend() {
    const historyItems = document.getElementById("history-items");
    if (!historyItems) return;
    
    try {
      const res = await fetch("/ai/history");
      const data = await res.json();
      
      if (data.ok && data.history && data.history.length) {
        historyItems.innerHTML = data.history.map(function(item) {
          const size = item.size || '10g';
          return `
            <div class="sidebar-item" data-product-id="${item.id}" data-price="${item.price_sar}" data-size="${size}" data-image="${item.image_url}" data-name="${item.name}">
              <img src="${item.image_url}" alt="${item.name}" onerror="this.src='/static/images/BF_Slogo.png'">
              <div class="sidebar-item-name">${item.name}</div>
              <div class="sidebar-item-info">${item.price_sar} SAR â€¢ ${size}</div>
              <div class="sidebar-item-actions">
                <button class="sidebar-item-btn load-design"><i class="fas fa-eye"></i> View</button>
                <button class="sidebar-item-btn favorite"><i class="fas fa-heart"></i></button>
              </div>
            </div>
          `;
        }).join("");
        attachSidebarListeners();
      } else {
        historyItems.innerHTML = '<div class="empty-state"><i class="fas fa-image"></i><p>No designs yet</p><span>Start creating to see your history</span></div>';
      }
    } catch (err) {
      console.error("Error loading history:", err);
    }
  }

  // Load Favorites
  async function loadFavoritesFromBackend() {
    const favContainer = document.getElementById("favorites-tab");
    if (!favContainer) return;
    
    try {
      const res = await fetch("/ai/favorites");
      const data = await res.json();
      
      if (data.ok && data.favorites && data.favorites.length) {
        favContainer.innerHTML = data.favorites.map(function(item) {
          const size = item.size || '10g';
          return `
            <div class="sidebar-item" data-product-id="${item.id}" data-price="${item.price_sar}" data-size="${size}" data-image="${item.image_url}" data-name="${item.name}">
              <img src="${item.image_url}" alt="${item.name}" onerror="this.src='/static/images/BF_Slogo.png'">
              <div class="sidebar-item-name">${item.name}</div>
              <div class="sidebar-item-info">${item.price_sar} SAR â€¢ ${size}</div>
              <div class="sidebar-item-actions">
                <button class="sidebar-item-btn load-design"><i class="fas fa-eye"></i> View</button>
                <button class="sidebar-item-btn remove-favorite"><i class="fas fa-trash"></i></button>
              </div>
            </div>
          `;
        }).join("");
        attachSidebarListeners();
      } else {
        favContainer.innerHTML = '<div class="empty-state"><i class="fas fa-heart"></i><p>No favorites yet</p><span>Save designs you love</span></div>';
      }
    } catch (err) {
      console.error("Error loading favorites:", err);
    }
  }

  // âœ… Use EVENT DELEGATION - attach once, works forever
  // This prevents duplicate event listeners!
  
  document.addEventListener("click", function(e) {
    // Handle View/Load Design button
    const loadBtn = e.target.closest(".sidebar-item .load-design");
    if (loadBtn) {
      e.stopPropagation();
      const item = loadBtn.closest(".sidebar-item");
      const productId = item.dataset.productId;
      const img = item.querySelector("img").src;
      const name = item.dataset.name;
      const price = parseFloat(item.dataset.price) || 120;
      const size = item.dataset.size || "10g";
      
      const card1 = document.getElementById("card-1");
      const card2 = document.getElementById("card-2");
      
      console.log("ðŸ” Card states - card1Filled:", card1Filled, "card2Filled:", card2Filled);
      
      if (!card1Filled) {
        console.log("ðŸ“¦ Loading into Card 1 ONLY");
        loadProductIntoCard(card1, { id: productId, name, price, size, image: img });
        card1Filled = true;
        
      } else if (!card2Filled) {
        console.log("ðŸ“¦ Loading into Card 2");
        convertPlaceholderToCard(card2, { id: productId, name, price, size, image: img });
        card2Filled = true;
        
      } else {
        console.log("ðŸ“¦ Both filled - replacing Card 1");
        loadProductIntoCard(card1, { id: productId, name, price, size, image: img });
      }
      
      showCards();
      closeSidebar();
      showToast(`âœ… Loaded: ${name}`);
      return;
    }
    
    // Handle Add to Favorites button (in history)
    const favBtn = e.target.closest(".sidebar-item .favorite");
    if (favBtn) {
      e.stopPropagation();
      const item = favBtn.closest(".sidebar-item");
      const productId = item.dataset.productId;
      if (!productId) return;
      
      fetch("/ai/favorites/add", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ product_id: parseInt(productId) })
      })
      .then(res => res.json())
      .then(data => {
        if (data.ok) {
          showToast("â¤ï¸ Added to favorites!");
          loadFavoritesFromBackend();
        } else {
          showToast(data.message || "Already in favorites");
        }
      })
      .catch(err => console.error("Error:", err));
      return;
    }
    
    // Handle Remove from Favorites button
    const removeBtn = e.target.closest(".sidebar-item .remove-favorite");
    if (removeBtn) {
      e.stopPropagation();
      const item = removeBtn.closest(".sidebar-item");
      const productId = item.dataset.productId;
      
      fetch("/ai/favorites/remove", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ product_id: parseInt(productId) })
      })
      .then(res => {
        if (res.ok) {
          showToast("Removed from favorites");
          loadFavoritesFromBackend();
        }
      })
      .catch(err => console.error("Error:", err));
      return;
    }
  });

  // Empty function - we use event delegation now
  function attachSidebarListeners() {
    // Do nothing - event delegation handles everything
  }

  // Load product into card (card element passed directly)
  function loadProductIntoCard(card, product) {
    if (!card) return;

    const img = card.querySelector(".sp-img img");
    if (img) {
      img.src = product.image;
      img.alt = product.name;
    }

    const nameText = card.querySelector(".name-text");
    if (nameText) nameText.textContent = product.name;

    const priceEl = card.querySelector(".price-value");
    if (priceEl) priceEl.textContent = product.price;

    const specType = card.querySelector(".spec-type");
    if (specType) specType.innerHTML = `<i class="fas fa-tag"></i> Custom`;

    const specFinish = card.querySelector(".spec-finish");
    if (specFinish) specFinish.innerHTML = `<i class="fas fa-star"></i> Premium`;

    const btn = card.querySelector(".sp-select");
    if (btn) {
      btn.dataset.id = product.id;
      btn.dataset.name = product.name;
      btn.dataset.price = product.price;
      btn.dataset.image = product.image;
      btn.dataset.size = product.size;
    }

    card.dataset.productId = product.id;
    card.dataset.productName = product.name;
    card.dataset.productPrice = product.price;
    card.dataset.productSize = product.size;
    card.dataset.productImage = product.image;
    card.dataset.specs = JSON.stringify({});
    card.dataset.pricing = JSON.stringify({ base_price: 50, final_price: product.price });

    attachEditListeners();
  }

  // Convert placeholder card to product card
  function convertPlaceholderToCard(card, product) {
    if (!card) return;

    // Replace placeholder HTML with product card HTML
    card.classList.remove("placeholder-card");
    card.classList.add("generated-card");
    
    card.innerHTML = `
      <div class="sp-card-menu">
        <button class="menu-toggle"><i class="fas fa-ellipsis-v"></i></button>
        <div class="menu-dropdown">
          <button class="menu-item view-details"><i class="fas fa-info-circle"></i> View Details</button>
          <button class="menu-item add-favorite"><i class="fas fa-heart"></i> Add to Favorites</button>
          <button class="menu-item share-product"><i class="fas fa-share-alt"></i> Share</button>
        </div>
      </div>
      
      <div class="sp-img">
        <img src="${product.image}" alt="${product.name}" />
        <div class="sp-badge">AI Generated</div>
      </div>
      
      <div class="sp-card-info">
        <h3 class="sp-product-name">
          <span class="name-text">${product.name}</span>
          <button class="edit-name-btn" title="Edit name">
            <i class="fas fa-pen"></i>
          </button>
        </h3>
        <div class="sp-product-specs">
          <span class="spec-badge spec-type"><i class="fas fa-tag"></i> Custom</span>
          <span class="spec-badge spec-finish"><i class="fas fa-star"></i> Premium</span>
        </div>
        <p class="sp-product-price"><span class="price-value">${product.price}</span> SAR</p>
      </div>
      
      <button class="sp-select" data-id="${product.id}" data-name="${product.name}" data-price="${product.price}" data-image="${product.image}" data-size="${product.size}">
        <i class="fas fa-shopping-cart"></i> Add to Cart
      </button>
    `;

    card.dataset.productId = product.id;
    card.dataset.productName = product.name;
    card.dataset.productPrice = product.price;
    card.dataset.productSize = product.size;
    card.dataset.productImage = product.image;
    card.dataset.specs = JSON.stringify({});
    card.dataset.pricing = JSON.stringify({ base_price: 50, final_price: product.price });

    attachEditListeners();
  }

  // ========================================
  // SHOW/HIDE STATES
  // ========================================
  function showEmpty() {
    if (emptyState) {
      emptyState.classList.remove("hide");
      emptyState.style.display = "grid";
    }
    if (loadingState) {
      loadingState.classList.remove("show");
      loadingState.style.display = "none";
    }
    if (cardsContainer) {
      cardsContainer.classList.add("hide");
      cardsContainer.style.display = "none";
    }
  }

  function showLoading() {
    if (emptyState) {
      emptyState.classList.add("hide");
      emptyState.style.display = "none";
    }
    if (loadingState) {
      loadingState.classList.add("show");
      loadingState.style.display = "grid";
    }
    if (cardsContainer) {
      cardsContainer.classList.add("hide");
      cardsContainer.style.display = "none";
    }
  }

  function showCards() {
    if (emptyState) {
      emptyState.classList.add("hide");
      emptyState.style.display = "none";
    }
    if (loadingState) {
      loadingState.classList.remove("show");
      loadingState.style.display = "none";
    }
    if (cardsContainer) {
      cardsContainer.classList.remove("hide");
      cardsContainer.style.display = "grid";
    }
  }

  // ========================================
  // GENERATE PRODUCTS
  // ========================================
  async function generateProducts(vibe) {
    console.log("ðŸŽ¨ Generating products for vibe:", vibe);
    showLoading();

    try {
      for (let i = 0; i < 2; i++) {
        const specs = generateSpecs(vibe);
        const pricing = calculatePrice(specs);
        const productName = generateName(specs, vibe);
        const productSize = getProductSize(specs.product_type);
        const prompt = buildPrompt(specs, vibe);

        console.log(`ðŸ“¦ Product ${i + 1}: ${productName} - ${pricing.final_price} SAR - ${productSize}`);

        const res = await fetch("/ai/generate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt, context: "smartpicks", vibe })
        });

        const data = await res.json();

        if (data.ok && data.image_url) {
          let card;
          if (i === 0) {
            card = document.getElementById("card-1");
          } else {
            card = document.getElementById("card-2");
            // Convert card 2 from placeholder if needed
            if (card.classList.contains("placeholder-card")) {
              card.classList.remove("placeholder-card");
              card.classList.add("generated-card");
              card.innerHTML = `
                <div class="sp-card-menu">
                  <button class="menu-toggle"><i class="fas fa-ellipsis-v"></i></button>
                  <div class="menu-dropdown">
                    <button class="menu-item view-details"><i class="fas fa-info-circle"></i> View Details</button>
                    <button class="menu-item add-favorite"><i class="fas fa-heart"></i> Add to Favorites</button>
                    <button class="menu-item share-product"><i class="fas fa-share-alt"></i> Share</button>
                  </div>
                </div>
                
                <div class="sp-img">
                  <img src="" alt="AI Product 2" />
                  <div class="sp-badge">AI Generated</div>
                </div>
                
                <div class="sp-card-info">
                  <h3 class="sp-product-name">
                    <span class="name-text">Custom Product</span>
                    <button class="edit-name-btn" title="Edit name">
                      <i class="fas fa-pen"></i>
                    </button>
                  </h3>
                  <div class="sp-product-specs">
                    <span class="spec-badge spec-type"><i class="fas fa-tag"></i> Product</span>
                    <span class="spec-badge spec-finish"><i class="fas fa-star"></i> Premium</span>
                  </div>
                  <p class="sp-product-price"><span class="price-value">0</span> SAR</p>
                </div>
                
                <button class="sp-select">
                  <i class="fas fa-shopping-cart"></i> Add to Cart
                </button>
              `;
            }
          }
          
          if (!card) continue;

          const productId = data.product?.id || `sp-${Date.now()}-${i}`;

          const img = card.querySelector(".sp-img img");
          if (img) {
            img.src = data.image_url;
            img.alt = productName;
          }

          const nameText = card.querySelector(".name-text");
          if (nameText) nameText.textContent = productName;

          const priceEl = card.querySelector(".price-value");
          if (priceEl) priceEl.textContent = pricing.final_price;

          const specType = card.querySelector(".spec-type");
          const specFinish = card.querySelector(".spec-finish");
          if (specType) specType.innerHTML = `<i class="fas fa-tag"></i> ${specs.product_type}`;
          if (specFinish) specFinish.innerHTML = `<i class="fas fa-star"></i> ${specs.finish}`;

          const btn = card.querySelector(".sp-select");
          if (btn) {
            btn.dataset.id = productId;
            btn.dataset.name = productName;
            btn.dataset.price = pricing.final_price;
            btn.dataset.image = data.image_url;
            btn.dataset.size = productSize;
          }

          card.dataset.productId = productId;
          card.dataset.productName = productName;
          card.dataset.productPrice = pricing.final_price;
          card.dataset.productSize = productSize;
          card.dataset.productImage = data.image_url;
          card.dataset.specs = JSON.stringify(specs);
          card.dataset.pricing = JSON.stringify(pricing);
        }
      }

      showCards();
      attachEditListeners();
      console.log("âœ… Products generated successfully");

    } catch (err) {
      console.error("âŒ Error:", err);
      showToast("âŒ Failed to generate products");
      showEmpty();
    }
  }

  // ========================================
  // EDIT NAME
  // ========================================
  function attachEditListeners() {
    document.querySelectorAll(".edit-name-btn").forEach(btn => {
      const newBtn = btn.cloneNode(true);
      btn.parentNode.replaceChild(newBtn, btn);
      
      newBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        const card = newBtn.closest(".sp-card");
        const nameContainer = card.querySelector(".sp-product-name");
        const currentName = card.querySelector(".name-text").textContent;

        nameContainer.innerHTML = `
          <div class="edit-name-wrapper">
            <input type="text" class="edit-name-input" value="${currentName}" maxlength="40">
            <button class="save-name-btn"><i class="fas fa-check"></i></button>
            <button class="cancel-name-btn"><i class="fas fa-times"></i></button>
          </div>
        `;

        const input = nameContainer.querySelector(".edit-name-input");
        input.focus();
        input.select();

        nameContainer.querySelector(".save-name-btn").onclick = () => saveName(card, input.value.trim() || currentName);
        nameContainer.querySelector(".cancel-name-btn").onclick = () => restoreName(card, currentName);
        input.onkeydown = (e) => {
          if (e.key === "Enter") saveName(card, input.value.trim() || currentName);
          if (e.key === "Escape") restoreName(card, currentName);
        };
      });
    });
  }

  function saveName(card, name) {
    const productId = card.dataset.productId;
    
    if (productId && !productId.startsWith('sp-')) {
      fetch("/ai/product/update-name", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ product_id: productId, name: name })
      })
      .then(res => res.json())
      .then(data => {
        if (data.ok) console.log("âœ… Name saved to DB:", name);
      })
      .catch(err => console.log("Save error:", err));
    }
    
    card.dataset.productName = name;
    const btn = card.querySelector(".sp-select");
    if (btn) btn.dataset.name = name;
    
    card.querySelector(".sp-product-name").innerHTML = `
      <span class="name-text">${name}</span>
      <button class="edit-name-btn" title="Edit name"><i class="fas fa-pen"></i></button>
    `;
    attachEditListeners();
    showToast(`âœ… Name: "${name}"`);
  }

  function restoreName(card, name) {
    card.querySelector(".sp-product-name").innerHTML = `
      <span class="name-text">${name}</span>
      <button class="edit-name-btn" title="Edit name"><i class="fas fa-pen"></i></button>
    `;
    attachEditListeners();
  }

  // ========================================
  // EVENT LISTENERS
  // ========================================
  
  // Vibe buttons
  vibeButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      vibeButtons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      
      // âœ… Reset card tracking when generating new products
      card1Filled = false;
      card2Filled = false;
      
      // Reset card 2 to placeholder if it was converted
      const card2 = document.getElementById("card-2");
      if (card2 && !card2.classList.contains("placeholder-card")) {
        card2.classList.remove("generated-card");
        card2.classList.add("placeholder-card");
        card2.innerHTML = `
          <div class="card-placeholder-content">
            <div class="placeholder-icon">
              <i class="fas fa-image"></i>
            </div>
            <h3>Select Another Design</h3>
            <p>Click <strong>View</strong> from History to display here</p>
          </div>
        `;
        card2.dataset.productId = "";
      }
      
      // Reset card 1 data
      const card1 = document.getElementById("card-1");
      if (card1) {
        card1.dataset.productId = "";
      }
      
      generateProducts(btn.dataset.vibe);
    });
  });

  // Menu toggle
  document.addEventListener("click", (e) => {
    const toggle = e.target.closest(".menu-toggle");
    if (toggle) {
      e.stopPropagation();
      const menu = toggle.closest(".sp-card-menu");
      document.querySelectorAll(".sp-card-menu").forEach(m => {
        if (m !== menu) m.classList.remove("open");
      });
      menu.classList.toggle("open");
    } else {
      document.querySelectorAll(".sp-card-menu").forEach(m => m.classList.remove("open"));
    }
  });

  // View Details
  document.addEventListener("click", (e) => {
    const viewBtn = e.target.closest(".view-details");
    if (!viewBtn) return;

    const card = viewBtn.closest(".sp-card");
    const specs = JSON.parse(card.dataset.specs || "{}");
    const pricing = JSON.parse(card.dataset.pricing || "{}");

    document.getElementById("modalProductImage").src = card.dataset.productImage || "";
    document.getElementById("modalProductName").textContent = card.dataset.productName || "Product";
    document.getElementById("modalFinalPrice").textContent = `${card.dataset.productPrice || 0} SAR`;
    document.getElementById("modalBasePrice").textContent = `${pricing.base_price || 50} SAR`;
    document.getElementById("modalProductType").textContent = specs.product_type || "Product";
    document.getElementById("modalFormula").textContent = specs.formula || "Premium";
    document.getElementById("modalCoverage").textContent = specs.coverage || "Medium";
    document.getElementById("modalFinish").textContent = specs.finish || "Natural";
    document.getElementById("modalSkinType").textContent = specs.skin_type || "All";
    document.getElementById("modalSize").textContent = card.dataset.productSize || "10g";

    detailsModal.classList.add("active");
    detailsModal.dataset.productId = card.dataset.productId;
    detailsModal.dataset.productName = card.dataset.productName;
    detailsModal.dataset.productPrice = card.dataset.productPrice;
    detailsModal.dataset.productSize = card.dataset.productSize;
    detailsModal.dataset.productImage = card.dataset.productImage;
  });

  // Close Modal
  function closeModal() {
    detailsModal.classList.remove("active");
  }
  
  document.querySelector(".modal-close")?.addEventListener("click", closeModal);
  document.querySelector(".modal-overlay")?.addEventListener("click", closeModal);

  // ESC to close
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") {
      closeModal();
      closeSidebar();
    }
  });

  // Add to Cart
  document.addEventListener("click", async (e) => {
    const btn = e.target.closest(".sp-select, .add-to-cart-modal");
    if (!btn) return;

    let id, name, price, image, size;

    if (btn.classList.contains("add-to-cart-modal")) {
      id = detailsModal.dataset.productId;
      name = detailsModal.dataset.productName;
      price = detailsModal.dataset.productPrice;
      image = detailsModal.dataset.productImage;
      size = detailsModal.dataset.productSize;
    } else {
      id = btn.dataset.id;
      name = btn.dataset.name;
      price = btn.dataset.price;
      image = btn.dataset.image;
      size = btn.dataset.size;
    }

    if (!id || !name) {
      showToast("âš ï¸ Please generate products first");
      return;
    }

    try {
      const res = await fetch("/cart/add", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id, name, price, image, size })
      });

      const data = await res.json();
      if (data.ok) {
        showToast(`âœ… ${name} added!`);
        document.getElementById("cart-count").textContent = data.cart_count || 0;
        if (btn.classList.contains("add-to-cart-modal")) closeModal();
      }
    } catch (err) {
      showToast("âŒ Error");
    }
  });

  // Favorites from card menu
  document.addEventListener("click", async (e) => {
    const btn = e.target.closest(".add-favorite, .add-favorite-modal");
    if (!btn) return;

    const card = btn.closest(".sp-card");
    const id = card ? card.dataset.productId : detailsModal.dataset.productId;

    if (!id) {
      showToast("âš ï¸ No product");
      return;
    }

    try {
      const res = await fetch("/ai/favorites/add", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ product_id: id })
      });
      const data = await res.json();
      if (data.ok) {
        showToast("â¤ï¸ Added to favorites!");
      } else {
        showToast(data.message || "Already in favorites");
      }
    } catch (err) {
      showToast("âŒ Error");
    }
  });

  // Share
  document.addEventListener("click", async (e) => {
    const btn = e.target.closest(".share-product");
    if (!btn) return;
    
    if (navigator.share) {
      try { await navigator.share({ url: window.location.href }); } catch (err) {}
    } else {
      navigator.clipboard.writeText(window.location.href);
      showToast("ðŸ”— Link copied!");
    }
  });

  // Toast
  function showToast(msg) {
    const toast = document.getElementById("toast");
    toast.textContent = msg;
    toast.classList.add("show");
    setTimeout(() => toast.classList.remove("show"), 3000);
  }

  // Load cart count
  fetch('/cart/count')
    .then(r => r.json())
    .then(d => document.getElementById("cart-count").textContent = d.count || 0)
    .catch(() => {});

  // Header scroll
  const header = document.getElementById("mainHeader");
  let lastY = 0;
  window.addEventListener("scroll", () => {
    const y = window.pageYOffset;
    if (y > lastY && y > 100) header.classList.add("hide");
    else header.classList.remove("hide");
    if (y > 20) header.classList.add("scrolled");
    else header.classList.remove("scrolled");
    lastY = y;
  });

  // Mobile menu
  const menuBtn = document.getElementById("mobileMenuBtn");
  const mobileMenu = document.getElementById("mobileMenu");
  if (menuBtn && mobileMenu) {
    menuBtn.addEventListener("click", () => {
      menuBtn.classList.toggle("active");
      mobileMenu.classList.toggle("open");
    });
  }
});
  </script>
  <!-- ðŸ¤– AI Bot -->
  {% include 'aiBot.html' %}
</body>
</html>